<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Getting Started with bitfield</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Getting Started with bitfield</h1>



<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(bitfield)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>(dplyr, <span class="at">warn.conflicts =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>This guide walks through the core workflow of the
<code>bitfield</code> package: planning an encoding, choosing protocols,
finding optimal bit allocations, and sharing protocols with the
community.</p>
<div id="the-example-data" class="section level2">
<h2>The example data</h2>
<p>The package ships with <code>bf_tbl</code>, a small dataset with
typical quality issues (missing values, invalid coordinates, mixed
formats):</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>bf_tbl</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="co">#&gt; # A tibble: 9 × 5</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="co">#&gt;       x     y commodity yield year </span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt;     &lt;dbl&gt; &lt;chr&gt;</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="co">#&gt; 1  25.3  59.5 soybean   11.2  2021 </span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="co">#&gt; 2  27.9  58.1 maize     12.0  &lt;NA&gt; </span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="co">#&gt; 3  27.8  57.8 soybean   13.2  2021r</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a><span class="co">#&gt; 4  27    59.2 &lt;NA&gt;       4.43 2021 </span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a><span class="co">#&gt; 5 259   Inf   honey     13.0  2021 </span></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a><span class="co">#&gt; 6  27.3  59.1 maize      8.55 2021 </span></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a><span class="co">#&gt; 7  26.1  58.4 soybean   11.3  2021 </span></span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a><span class="co">#&gt; 8  26.5 NaN   maize     10.6  2021 </span></span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a><span class="co">#&gt; 9   0     0   soybean    9.01 2021</span></span></code></pre></div>
</div>
<div id="encoding-types-at-a-glance" class="section level2">
<h2>Encoding types at a glance</h2>
<p>Every bit flag uses one of a few encoding types. The table below
summarises when to use which:</p>
<table style="width:100%;">
<colgroup>
<col width="22%" />
<col width="22%" />
<col width="33%" />
<col width="22%" />
</colgroup>
<thead>
<tr class="header">
<th>Encoding</th>
<th>Protocol</th>
<th>Key parameters</th>
<th>Use when</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Boolean</td>
<td><code>na</code>, <code>inf</code>, <code>matches</code></td>
<td><code>set</code></td>
<td>Yes/no flags (1 bit each)</td>
</tr>
<tr class="even">
<td>Enumeration</td>
<td><code>category</code></td>
<td><code>na.val</code></td>
<td>Discrete classes (auto-sized)</td>
</tr>
<tr class="odd">
<td>Integer</td>
<td><code>integer</code></td>
<td><code>range</code>, <code>fields</code></td>
<td>Bounded values with uniform precision</td>
</tr>
<tr class="even">
<td>Floating-point</td>
<td><code>numeric</code></td>
<td><code>fields</code> (exp/sig)</td>
<td>Open-ended values spanning orders of magnitude</td>
</tr>
</tbody>
</table>
<p><strong>Integer encoding</strong> maps a bounded range linearly onto
bit states. Good for percentages, indices, and quantities with
well-defined limits.</p>
<p><strong>Floating-point encoding</strong> splits bits into exponent
and significand fields. Precision is finest near zero and coarsens with
magnitude. Good for standard deviations, rates, and other variables that
can span several orders of magnitude.</p>
<p>When in doubt, <code>bf_analyze()</code> helps decide.</p>
</div>
<div id="using-bf_analyze-to-find-optimal-bit-allocations" class="section level2">
<h2>Using bf_analyze() to find optimal bit allocations</h2>
<p><code>bf_analyze()</code> works with any data type. For booleans,
integers, and categories it reports the required bit count directly. For
floating-point data it evaluates all possible exponent/significand
configurations and reports those on the Pareto front for each total bit
count.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">1000</span>, <span class="fl">0.1</span>, <span class="dv">10</span>)</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="fu">bf_analyze</span>(x, <span class="at">range =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">15</span>), <span class="at">max_bits =</span> <span class="dv">8</span>, <span class="at">decimals =</span> <span class="dv">1</span>)</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="co">#&gt; Float Analysis</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="co">#&gt; ==============</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="co">#&gt;   Observations      1000</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a><span class="co">#&gt;   NA values         0</span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a><span class="co">#&gt;   Range             [0.102365, 9.98506]</span></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a><span class="co">#&gt;   Levels            -</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a><span class="co">#&gt;   Sign required     no</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a><span class="co">#&gt;   Bits required     select from the table below</span></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a><span class="co">#&gt;   Suggested na.val  automatic </span></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a><span class="co">#&gt;   Target range      [0.102365, 15]</span></span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a><span class="co">#&gt;   Decimals          1</span></span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a><span class="co">#&gt; Exp  Sig  Total  Underflow  Overflow  Changed     Min Res     Max Res        RMSE     Max Err</span></span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a><span class="co">#&gt; ---  ---  -----  ---------  --------  -------  ----------  ----------  ----------  ----------</span></span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a><span class="co">#&gt;   2    1      3      4.2%    19.8%    95.8%      0.2500      2.0000      2.3762      6.0000</span></span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a><span class="co">#&gt;   2    2      4      4.2%    19.8%    91.9%      0.1250      1.0000      1.4195      4.0000</span></span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a><span class="co">#&gt;   3    1      4      0.7%     0.0%    94.0%      0.0625      4.0000      0.9339      2.0000</span></span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a><span class="co">#&gt;   2    3      5      4.2%    19.8%    84.5%      0.0625      0.5000      0.9514      3.0000</span></span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a><span class="co">#&gt;   3    2      5      0.7%     0.0%    89.6%      0.0312      2.0000      0.6466      2.0000</span></span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a><span class="co">#&gt;   4    1      5      0.0%     0.0%    93.3%      0.0312      4.0000      0.9338      2.0000</span></span>
<span id="cb3-25"><a href="#cb3-25" tabindex="-1"></a><span class="co">#&gt;   2    4      6      4.2%    19.8%    70.6%      0.0312      0.2500      0.7265      2.5000</span></span>
<span id="cb3-26"><a href="#cb3-26" tabindex="-1"></a><span class="co">#&gt;   3    3      6      0.7%     0.0%    80.7%      0.0156      1.0000      0.3072      1.0000</span></span>
<span id="cb3-27"><a href="#cb3-27" tabindex="-1"></a><span class="co">#&gt;   4    2      6      0.0%     0.0%    88.9%      0.0156      2.0000      0.6465      2.0000</span></span>
<span id="cb3-28"><a href="#cb3-28" tabindex="-1"></a><span class="co">#&gt;   2    5      7      4.2%    19.8%    56.1%      0.0156      0.1250      0.5992      2.2000</span></span>
<span id="cb3-29"><a href="#cb3-29" tabindex="-1"></a><span class="co">#&gt;   3    4      7      0.7%     0.0%    65.3%      0.0078      0.5000      0.1626      0.5000</span></span>
<span id="cb3-30"><a href="#cb3-30" tabindex="-1"></a><span class="co">#&gt;   4    3      7      0.0%     0.0%    80.0%      0.0078      1.0000      0.3071      1.0000</span></span>
<span id="cb3-31"><a href="#cb3-31" tabindex="-1"></a><span class="co">#&gt;   2    6      8      4.2%    19.8%    40.7%      0.0078      0.0625      0.5578      2.1000</span></span>
<span id="cb3-32"><a href="#cb3-32" tabindex="-1"></a><span class="co">#&gt;   3    5      8      0.7%     0.0%    48.7%      0.0039      0.2500      0.0895      0.3000</span></span>
<span id="cb3-33"><a href="#cb3-33" tabindex="-1"></a><span class="co">#&gt;   4    4      8      0.0%     0.0%    64.6%      0.0039      0.5000      0.1624      0.5000</span></span>
<span id="cb3-34"><a href="#cb3-34" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb3-35"><a href="#cb3-35" tabindex="-1"></a><span class="co">#&gt; Usage:</span></span>
<span id="cb3-36"><a href="#cb3-36" tabindex="-1"></a><span class="co">#&gt;   bf_map(protocol = &quot;numeric&quot;, ...,</span></span>
<span id="cb3-37"><a href="#cb3-37" tabindex="-1"></a><span class="co">#&gt;          fields = list(exponent = &lt;exp&gt;, significand = &lt;sig&gt;))</span></span></code></pre></div>
<p>The Pareto table shows multiple rows per bit count when trade-offs
exist. Key columns:</p>
<ul>
<li><strong>Underflow/Overflow</strong> – percentage of values outside
the representable range</li>
<li><strong>Changed</strong> – percentage differing after round-trip
encoding at the specified decimal precision</li>
<li><strong>Min/Max Res</strong> – step size at smallest and largest
representable values</li>
<li><strong>RMSE / Max Err</strong> – encoding error metrics</li>
</ul>
<p>For example, at 7 total bits, <code>exp=4/sig=3</code> covers the
full range (no underflow) while <code>exp=3/sig=4</code> offers finer
precision but cannot represent values below <span class="math inline">\(2^{-3} = 0.125\)</span>. Neither dominates the
other, so both appear.</p>
<p>Use the result to pick a configuration, then pass it to
<code>bf_map()</code>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co"># After deciding on exp=4, sig=3 based on bf_analyze() output:</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>reg <span class="ot">&lt;-</span> <span class="fu">bf_map</span>(<span class="at">protocol =</span> <span class="st">&quot;numeric&quot;</span>, <span class="at">data =</span> my_data, <span class="at">x =</span> sd_values,</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>              <span class="at">registry =</span> reg, <span class="at">fields =</span> <span class="fu">list</span>(<span class="at">exponent =</span> <span class="dv">4</span>, <span class="at">significand =</span> <span class="dv">3</span>))</span></code></pre></div>
</div>
<div id="a-complete-example" class="section level2">
<h2>A complete example</h2>
<p>Here is a full workflow using <code>bf_tbl</code>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co"># 1. Create a registry</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>reg <span class="ot">&lt;-</span> <span class="fu">bf_registry</span>(</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>  <span class="at">name =</span> <span class="st">&quot;yield_QA&quot;</span>,</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>  <span class="at">description =</span> <span class="st">&quot;Quality assessment for yield data&quot;</span>,</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>  <span class="at">template =</span> bf_tbl)</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a><span class="co"># 2. Add boolean flags</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>reg <span class="ot">&lt;-</span> <span class="fu">bf_map</span>(<span class="at">protocol =</span> <span class="st">&quot;na&quot;</span>, <span class="at">data =</span> bf_tbl, <span class="at">x =</span> commodity, <span class="at">registry =</span> reg)</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>reg <span class="ot">&lt;-</span> <span class="fu">bf_map</span>(<span class="at">protocol =</span> <span class="st">&quot;inf&quot;</span>, <span class="at">data =</span> bf_tbl, <span class="at">x =</span> x, <span class="at">registry =</span> reg)</span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>reg <span class="ot">&lt;-</span> <span class="fu">bf_map</span>(<span class="at">protocol =</span> <span class="st">&quot;inf&quot;</span>, <span class="at">data =</span> bf_tbl, <span class="at">x =</span> y, <span class="at">registry =</span> reg)</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a><span class="co"># 3. Add a category</span></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>reg <span class="ot">&lt;-</span> <span class="fu">bf_map</span>(<span class="at">protocol =</span> <span class="st">&quot;category&quot;</span>, <span class="at">data =</span> bf_tbl, <span class="at">x =</span> commodity,</span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>              <span class="at">registry =</span> reg, <span class="at">na.val =</span> <span class="dv">0</span><span class="dt">L</span>)</span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a><span class="co"># 4. Add a numeric value with custom float encoding</span></span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a>reg <span class="ot">&lt;-</span> <span class="fu">bf_map</span>(<span class="at">protocol =</span> <span class="st">&quot;numeric&quot;</span>, <span class="at">data =</span> bf_tbl, <span class="at">x =</span> yield,</span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a>              <span class="at">registry =</span> reg, <span class="at">format =</span> <span class="st">&quot;half&quot;</span>)</span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a>reg</span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a><span class="co">#&gt;   type  data.frame</span></span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a><span class="co">#&gt;   width 21</span></span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a><span class="co">#&gt;   flags 5  -|-|-|--|----------------</span></span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a><span class="co">#&gt;   pos encoding  name     col</span></span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a><span class="co">#&gt;   1   0.0.1/0   na       commodity</span></span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a><span class="co">#&gt;   2   0.0.1/0   inf      x</span></span>
<span id="cb5-28"><a href="#cb5-28" tabindex="-1"></a><span class="co">#&gt;   3   0.0.1/0   inf      y</span></span>
<span id="cb5-29"><a href="#cb5-29" tabindex="-1"></a><span class="co">#&gt;   4   0.0.2/0   category commodity</span></span>
<span id="cb5-30"><a href="#cb5-30" tabindex="-1"></a><span class="co">#&gt;   6   1.5.10/15 numeric  yield</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co"># 5. Encode and decode</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>field <span class="ot">&lt;-</span> <span class="fu">bf_encode</span>(<span class="at">registry =</span> reg)</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>decoded <span class="ot">&lt;-</span> <span class="fu">bf_decode</span>(field, <span class="at">registry =</span> reg, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="fu">head</span>(decoded, <span class="dv">3</span>)</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="co">#&gt; $na_commodity</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="co">#&gt; [1] 0 0 0 1 0 0 0 0 0</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a><span class="co">#&gt; $inf_x</span></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a><span class="co">#&gt; [1] 0 0 0 0 0 0 0 0 0</span></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a><span class="co">#&gt; $inf_y</span></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a><span class="co">#&gt; [1] 0 0 0 0 1 0 0 0 0</span></span></code></pre></div>
<div id="verify-round-trip-integrity" class="section level3">
<h3>Verify round-trip integrity</h3>
<p>Always check that the encode/decode cycle preserves essential
information:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co"># input NAs</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">is.na</span>(bf_tbl<span class="sc">$</span>commodity))</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="co">#&gt; [1] 1</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="co"># NAs after roundtrip</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a><span class="fu">sum</span>(decoded<span class="sc">$</span>na_commodity <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a><span class="co">#&gt; [1] 1</span></span></code></pre></div>
</div>
</div>
<div id="design-guidelines" class="section level2">
<h2>Design guidelines</h2>
<p><strong>Match precision to needs.</strong> Do not allocate 16 bits
where 5 suffice. Use <code>bf_analyze()</code> to quantify the
trade-off.</p>
<p><strong>Use atomic protocols.</strong> Each <code>bf_map()</code>
call should test one concept. This maximises reusability across
projects.</p>
<p><strong>Handle NA explicitly.</strong> Use the <code>na.val</code>
parameter to reserve a sentinel value for missing data. Choose a value
outside your data range (can be 0 when that value is not relevant in and
of itself, or the maximum integer state).</p>
<p><strong>Test with edge cases.</strong> Include <code>NA</code>,
<code>Inf</code>, <code>NaN</code>, zeros, and boundary values in your
test data:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>problematic <span class="ot">&lt;-</span> bf_tbl[<span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">8</span>, <span class="dv">9</span>), ]</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="fu">print</span>(problematic)</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="co">#&gt; # A tibble: 4 × 5</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="co">#&gt;       x     y commodity yield year </span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt;     &lt;dbl&gt; &lt;chr&gt;</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a><span class="co">#&gt; 1  27    59.2 &lt;NA&gt;       4.43 2021 </span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a><span class="co">#&gt; 2 259   Inf   honey     13.0  2021 </span></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a><span class="co">#&gt; 3  26.5 NaN   maize     10.6  2021 </span></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a><span class="co">#&gt; 4   0     0   soybean    9.01 2021</span></span></code></pre></div>
<p><strong>Choose units wisely.</strong> Livestock density in
animals/km<span class="math inline">\(^2\)</span> (range 0–290) needs 9
bits. The same quantity in animals/ha (range 0–3.1) needs only 5 bits.
Unit choice directly affects bit budget.</p>
</div>
<div id="creating-custom-protocols" class="section level2">
<h2>Creating custom protocols</h2>
<p>When built-in protocols do not cover your use case, create a custom
one with <code>bf_protocol()</code>. For example, some datasets embed
status flags directly in value strings – a year column might contain
<code>&quot;2021r&quot;</code> where <code>r</code> marks the value as revised.
The built-in <code>grepl</code> protocol can detect such flags as a
boolean, but a custom protocol can distinguish <em>which</em> flag is
present:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>valueFlag <span class="ot">&lt;-</span> <span class="fu">bf_protocol</span>(</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>  <span class="at">name =</span> <span class="st">&quot;valueFlag&quot;</span>,</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>  <span class="at">description =</span> <span class="fu">paste</span>(<span class="st">&quot;Extracts trailing status flags from {x}.&quot;</span>,</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>                      <span class="st">&quot;0 = none, 1 = r(evised), 2 = p(rovisional),&quot;</span>,</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>                      <span class="st">&quot;3 = e(stimated)&quot;</span>),</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>  <span class="at">test =</span> <span class="st">&quot;function(x) { suffix &lt;- sub(&#39;.*([a-z])$&#39;, &#39;</span><span class="sc">\\\\</span><span class="st">1&#39;, x); match(suffix, c(&#39;r&#39;,&#39;p&#39;,&#39;e&#39;), nomatch = 0L) }&quot;</span>,</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>  <span class="at">example =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="st">&quot;2020&quot;</span>, <span class="st">&quot;2021r&quot;</span>, <span class="st">&quot;2019p&quot;</span>, <span class="st">&quot;2018e&quot;</span>, <span class="cn">NA</span>)),</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">&quot;int&quot;</span>,</span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>  <span class="at">bits =</span> <span class="dv">2</span></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>)</span></code></pre></div>
<div id="versioning-and-extension" class="section level3">
<h3>Versioning and extension</h3>
<p>When improving existing protocols, use versioning to maintain
reproducibility:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>valueFlagV2 <span class="ot">&lt;-</span> <span class="fu">bf_protocol</span>(</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>  <span class="at">name =</span> <span class="st">&quot;valueFlag&quot;</span>,</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>  <span class="at">description =</span> <span class="fu">paste</span>(<span class="st">&quot;Extracts trailing status flags from {x}.&quot;</span>,</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>                      <span class="st">&quot;0 = none, 1 = r(evised), 2 = p(rovisional),&quot;</span>,</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>                      <span class="st">&quot;3 = e(stimated). Now also handles uppercase flags.&quot;</span>),</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>  <span class="at">test =</span> <span class="st">&quot;function(x) { suffix &lt;- sub(&#39;.*([a-zA-Z])$&#39;, &#39;</span><span class="sc">\\\\</span><span class="st">1&#39;, tolower(x)); match(suffix, c(&#39;r&#39;,&#39;p&#39;,&#39;e&#39;), nomatch = 0L) }&quot;</span>,</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>  <span class="at">example =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="st">&quot;2020&quot;</span>, <span class="st">&quot;2021r&quot;</span>, <span class="st">&quot;2019P&quot;</span>, <span class="st">&quot;2018e&quot;</span>, <span class="cn">NA</span>)),</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">&quot;int&quot;</span>,</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>  <span class="at">bits =</span> <span class="dv">2</span>,</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>  <span class="at">version =</span> <span class="st">&quot;1.1.0&quot;</span>,</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>  <span class="at">extends =</span> <span class="st">&quot;valueFlag_1.0.0&quot;</span>,</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>  <span class="at">note =</span> <span class="st">&quot;Now handles uppercase flags via case-insensitive matching&quot;</span></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>)</span></code></pre></div>
</div>
</div>
<div id="sharing-protocols-via-community-standards" class="section level2">
<h2>Sharing protocols via community standards</h2>
<p>The <a href="https://github.com/bitfloat/standards">bitfloat/standards</a>
repository enables sharing encoding protocols. Access it through
<code>bf_standards()</code>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co"># List available protocols</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="fu">bf_standards</span>(<span class="at">action =</span> <span class="st">&quot;list&quot;</span>)</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="co"># Pull a community protocol</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>soil_protocol <span class="ot">&lt;-</span> <span class="fu">bf_standards</span>(</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>  <span class="at">protocol =</span> <span class="st">&quot;soil_moisture&quot;</span>,</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>  <span class="at">remote =</span> <span class="st">&quot;environmental/soil&quot;</span>,</span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>  <span class="at">action =</span> <span class="st">&quot;pull&quot;</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>)</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a><span class="co"># Push your own protocol</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a><span class="fu">bf_standards</span>(</span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>  <span class="at">protocol =</span> dataAgeProtocol,</span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>  <span class="at">remote =</span> <span class="st">&quot;environmental/temporal&quot;</span>,</span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>  <span class="at">action =</span> <span class="st">&quot;push&quot;</span>,</span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a>  <span class="at">version =</span> <span class="st">&quot;1.0.0&quot;</span>,</span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>  <span class="at">change =</span> <span class="st">&quot;Initial release: data age encoding for environmental monitoring&quot;</span></span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a>)</span></code></pre></div>
<p>This requires a GitHub Personal Access Token. See
<code>?bf_standards</code> for setup instructions.</p>
</div>
<div id="quick-reference" class="section level2">
<h2>Quick reference</h2>
<p><strong>Do:</strong></p>
<ul>
<li>Plan your encoding before writing code</li>
<li>Use <code>bf_analyze()</code> for floating-point configurations</li>
<li>Test encode/decode round-trips</li>
<li>Use <code>na.val</code> for missing data</li>
<li>Keep protocols atomic (one concept each)</li>
<li>Document registries with descriptive names</li>
</ul>
<p><strong>Avoid:</strong></p>
<ul>
<li>Over-allocating bits for unnecessary precision</li>
<li>Encoding the same concept across multiple flags</li>
<li>Skipping edge case testing</li>
<li>Using floating-point encoding for bounded, uniform-precision
variables</li>
</ul>
<p>For more details, see the function documentation
(<code>?bf_map</code>, <code>?bf_analyze</code>,
<code>?bf_protocol</code>) and the package website at <a href="https://bitfloat.github.io/bitfield/" class="uri">https://bitfloat.github.io/bitfield/</a>.</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
